<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Forgot Password - Mothers' Union</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
    
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec37",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102213",
                        "accent-gold": "#C5A021",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    
    <style>
        body {
            font-family: "Public Sans", sans-serif;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #000;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark min-h-screen transition-colors duration-300">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <!-- Navigation Header -->
            <div class="w-full flex justify-center py-5 border-b border-solid border-[#e7f3e9] dark:border-[#2a3c2d]">
                <div class="layout-content-container flex flex-col max-w-[960px] flex-1 px-4 md:px-10">
                    <header class="flex items-center justify-between whitespace-nowrap">
                        <div class="flex items-center gap-4 text-[#0d1b10] dark:text-[#f8fcf9]">
                            <div class="size-6 text-primary">
                                <svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z" fill="currentColor"></path>
                                </svg>
                            </div>
                            <h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">Mothers' Union</h2>
                        </div>
                        <div class="flex flex-1 justify-end gap-8">
                            <!-- Only Login Button in Navigation -->
                            <a href="login.html" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-[#0d1b10] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-all">
                                <span class="truncate">Login</span>
                            </a>
                        </div>
                    </header>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <main class="flex-1 flex items-center justify-center py-12 px-4">
                <div class="layout-content-container flex flex-col max-w-[520px] w-full">
                    <!-- Recovery Card -->
                    <div class="p-1 @container">
                        <div class="flex flex-col items-stretch justify-start rounded-xl shadow-lg bg-white dark:bg-[#1a2e1d] overflow-hidden border border-[#e7f3e9] dark:border-[#2a3c2d]">
                            <!-- Header Image/Banner -->
                            <div class="w-full bg-center bg-no-repeat h-32 bg-cover" data-alt="Calm abstract green and gold background pattern" style="background-image: linear-gradient(135deg, #13ec37 0%, #C5A021 100%); opacity: 0.9;">
                                <div class="flex items-center justify-center h-full">
                                    <span class="material-symbols-outlined text-white text-5xl">lock_reset</span>
                                </div>
                            </div>
                            
                            <div class="flex w-full grow flex-col items-stretch justify-center gap-6 p-8">
                                <div class="space-y-2">
                                    <h1 class="text-[#0d1b10] dark:text-[#f8fcf9] text-2xl font-bold leading-tight tracking-[-0.015em] text-center">
                                        Reset Your Password
                                    </h1>
                                    <p class="text-[#4c9a59] dark:text-[#9bc4a2] text-base font-normal leading-normal text-center">
                                        Enter your registered email address below. We will send you a secure link to create a new password.
                                    </p>
                                </div>
                                
                                <!-- Form -->
                                <form id="resetForm" class="space-y-4">
                                    <!-- Email Field -->
                                    <div class="flex flex-wrap items-end gap-4">
                                        <label class="flex flex-col min-w-40 flex-1">
                                            <p class="text-[#0d1b10] dark:text-[#f8fcf9] text-sm font-semibold leading-normal pb-2">Registered Email Address</p>
                                            <div class="relative">
                                                <input 
                                                    id="emailInput"
                                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#0d1b10] dark:text-[#f8fcf9] focus:outline-none focus:ring-2 focus:ring-primary/50 border border-[#cfe7d3] dark:border-[#2a3c2d] bg-[#f8fcf9] dark:bg-[#102213] focus:border-primary h-14 placeholder:text-[#4c9a59]/60 p-[15px] pl-12 text-base font-normal leading-normal transition-all" 
                                                    placeholder="example@gmail.com" 
                                                    type="email" 
                                                    required
                                                />
                                                <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-[#4c9a59]">mail</span>
                                            </div>
                                            <div id="emailError" class="text-red-500 text-sm mt-1 hidden"></div>
                                        </label>
                                    </div>
                                    
                                    <!-- Email Domain Info -->
                                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                                        <div class="flex items-start gap-2">
                                            <span class="material-symbols-outlined text-blue-500 text-sm mt-0.5">info</span>
                                            <div>
                                                <p class="text-sm text-blue-700 dark:text-blue-300 font-medium">Using Gmail, Yahoo, or other email providers?</p>
                                                <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">Enter the same email you used when signing up (e.g., marykamau@gmail.com, john.doe@yahoo.com)</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Submit Button -->
                                    <button 
                                        id="submitButton"
                                        type="submit"
                                        class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-[#0d1b10] text-base font-bold leading-normal hover:shadow-md transition-all active:scale-[0.98] gap-2"
                                    >
                                        <span id="submitText">Send Reset Link</span>
                                        <div id="loadingSpinner" class="hidden loading-spinner"></div>
                                    </button>
                                </form>
                                
                                <!-- Success Message (Hidden by default) -->
                                <div id="successMessage" class="hidden mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl animate-fade-in">
                                    <div class="flex items-center gap-3">
                                        <span class="material-symbols-outlined text-green-600 dark:text-green-400">check_circle</span>
                                        <div>
                                            <p class="font-medium text-green-800 dark:text-green-300">Reset link sent successfully!</p>
                                            <p class="text-sm text-green-700 dark:text-green-400 mt-1">
                                                Check your email (including spam folder) for the password reset link.
                                                <span class="block font-medium mt-2">Demo: The reset link would be sent to your email in a real system.</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Error Message (Hidden by default) -->
                                <div id="errorMessage" class="hidden mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <span class="material-symbols-outlined text-red-600 dark:text-red-400">error</span>
                                        <div>
                                            <p id="errorText" class="text-red-700 dark:text-red-300 text-sm"></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Email Check Results (Hidden by default) -->
                                <div id="emailCheckResult" class="hidden mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl">
                                    <div class="flex items-start gap-3">
                                        <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 mt-0.5">warning</span>
                                        <div>
                                            <p id="emailCheckText" class="text-yellow-800 dark:text-yellow-300 text-sm"></p>
                                            <div class="mt-2 space-y-2">
                                                <button id="resetForUnregistered" class="text-xs text-primary hover:underline font-medium">
                                                    Request admin to reset password manually
                                                </button>
                                                <p class="text-xs text-yellow-600 dark:text-yellow-400">
                                                    Contact: mothersunion@ackctk.org
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="border-t border-[#e7f3e9] dark:border-[#2a3c2d] pt-6">
                                        <p class="text-[#0d1b10] dark:text-[#f8fcf9] text-sm font-normal leading-normal text-center px-4">
                                            If you need further assistance or no longer have access to this email, please contact the 
                                            <span class="font-semibold text-primary">Mothers' Union Secretary</span>.
                                        </p>
                                    </div>
                                    
                                    <div class="flex flex-col gap-2">
                                        <a class="flex items-center justify-center gap-2 text-[#4c9a59] dark:text-primary text-sm font-medium leading-normal hover:underline transition-all" href="login.html">
                                            <span class="material-symbols-outlined text-sm">arrow_back</span>
                                            Back to Login
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Page Footer / Copyright -->
                    <footer class="mt-8 text-center text-[#4c9a59] dark:text-[#9bc4a2] text-xs">
                        <p>Â© 2026 ACK Christ the King Mothers' Union. Secure Finance &amp; Records System.</p>
                    </footer>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const resetForm = document.getElementById('resetForm');
            const emailInput = document.getElementById('emailInput');
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const emailError = document.getElementById('emailError');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const emailCheckResult = document.getElementById('emailCheckResult');
            const emailCheckText = document.getElementById('emailCheckText');
            const resetForUnregistered = document.getElementById('resetForUnregistered');
            
            // Common email domains for regular users
            const commonEmailDomains = [
                'gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com',
                'icloud.com', 'aol.com', 'protonmail.com', 'zoho.com',
                'yandex.com', 'mail.com'
            ];
            
            // Check if email domain is common (Gmail, Yahoo, etc.)
            function isCommonEmailDomain(email) {
                const domain = email.split('@')[1]?.toLowerCase();
                return commonEmailDomains.includes(domain);
            }
            
            // Validate email format
            function validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            // Check if email exists in signup requests (case-insensitive)
            function checkEmailExists(email) {
                try {
                    const signupRequests = JSON.parse(localStorage.getItem('signupRequests') || '[]');
                    
                    // Find user with this email (case-insensitive)
                    const user = signupRequests.find(request => 
                        request.email.toLowerCase() === email.toLowerCase()
                    );
                    
                    if (user) {
                        return { 
                            exists: true, 
                            user: user,
                            isApproved: user.status === 'approved',
                            isPending: user.status === 'pending',
                            isRejected: user.status === 'rejected'
                        };
                    }
                    
                    return { exists: false };
                } catch (error) {
                    console.error('Error checking email:', error);
                    return { exists: false };
                }
            }
            
            // Show appropriate message based on user status
            function handleEmailStatus(email, emailCheck) {
                if (emailCheck.isPending) {
                    showEmailCheckResult(
                        'Your account is still pending admin approval. You cannot reset password until your account is approved.'
                    );
                    return false;
                }
                
                if (emailCheck.isRejected) {
                    showEmailCheckResult(
                        'Your account request was rejected. Please contact the admin for assistance.'
                    );
                    return false;
                }
                
                if (emailCheck.isApproved) {
                    // Generate and save reset token
                    const resetToken = generateResetToken();
                    saveResetToken(email, resetToken);
                    
                    // Save email for reset password page
                    localStorage.setItem('resetEmail', email);
                    
                    // Log for demo purposes
                    console.log(`Password reset initiated for: ${email}`);
                    console.log(`Reset token: ${resetToken}`);
                    console.log(`Demo reset URL: reset-password.html?token=${resetToken}&email=${encodeURIComponent(email)}`);
                    
                    return true;
                }
                
                // If email doesn't exist but is a common domain
                if (isCommonEmailDomain(email)) {
                    showEmailCheckResult(
                        'This email is not registered in our system. Did you use a different email when signing up?'
                    );
                    return false;
                }
                
                // For non-common domains
                showEmailCheckResult(
                    'This email is not registered in our system. Please check your email or contact support.'
                );
                return false;
            }
            
            // Show email check result message
            function showEmailCheckResult(message) {
                emailCheckText.textContent = message;
                emailCheckResult.classList.remove('hidden');
                emailCheckResult.classList.add('animate-fade-in');
            }
            
            // Hide email check result
            function hideEmailCheckResult() {
                emailCheckResult.classList.add('hidden');
            }
            
            // Generate a reset token
            function generateResetToken() {
                return Math.random().toString(36).substring(2, 15) + 
                       Math.random().toString(36).substring(2, 15);
            }
            
            // Save reset token to localStorage (for demo)
            function saveResetToken(email, token) {
                const resetTokens = JSON.parse(localStorage.getItem('resetTokens') || '{}');
                resetTokens[email] = {
                    token: token,
                    timestamp: Date.now(),
                    expires: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                };
                localStorage.setItem('resetTokens', JSON.stringify(resetTokens));
            }
            
            // Show error message
            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                errorMessage.classList.add('animate-fade-in');
                
                setTimeout(() => {
                    errorMessage.classList.add('hidden');
                }, 5000);
            }
            
            // Hide error message
            function hideError() {
                errorMessage.classList.add('hidden');
            }
            
            // Show success message
            function showSuccess() {
                successMessage.classList.remove('hidden');
                successMessage.classList.add('animate-fade-in');
                
                // Update placeholder for next time
                emailInput.placeholder = emailInput.value;
                emailInput.value = '';
                
                // Auto-redirect after 8 seconds
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 8000);
            }
            
            // Validate form
            function validateForm() {
                const email = emailInput.value.trim();
                emailError.classList.add('hidden');
                hideError();
                hideEmailCheckResult();
                
                if (!email) {
                    emailError.textContent = 'Email address is required';
                    emailError.classList.remove('hidden');
                    return false;
                }
                
                if (!validateEmail(email)) {
                    emailError.textContent = 'Please enter a valid email address';
                    emailError.classList.remove('hidden');
                    return false;
                }
                
                return true;
            }
            
            // Handle manual reset request for unregistered users
            resetForUnregistered.addEventListener('click', function() {
                const email = emailInput.value.trim();
                
                // Save manual reset request
                const manualRequests = JSON.parse(localStorage.getItem('manualResetRequests') || '[]');
                manualRequests.push({
                    email: email,
                    timestamp: new Date().toISOString(),
                    status: 'requested'
                });
                localStorage.setItem('manualResetRequests', JSON.stringify(manualRequests));
                
                alert(`Password reset request for ${email} has been sent to the admin. They will contact you.`);
                window.location.href = 'login.html';
            });
            
            // Handle form submission
            resetForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                if (!validateForm()) {
                    return;
                }
                
                const email = emailInput.value.trim();
                
                // Show loading state
                submitText.textContent = 'Checking email...';
                loadingSpinner.classList.remove('hidden');
                submitButton.disabled = true;
                
                // Simulate checking delay
                setTimeout(() => {
                    // Check if email exists and get status
                    const emailCheck = checkEmailExists(email);
                    
                    if (!emailCheck.exists) {
                        // Email doesn't exist
                        showEmailCheckResult(
                            `The email "${email}" is not registered in our system. Please check if you used a different email address when signing up.`
                        );
                        
                        // Reset button state
                        submitText.textContent = 'Send Reset Link';
                        loadingSpinner.classList.add('hidden');
                        submitButton.disabled = false;
                        return;
                    }
                    
                    // Handle based on user status
                    const canReset = handleEmailStatus(email, emailCheck);
                    
                    if (canReset) {
                        // Show success message
                        showSuccess();
                        
                        // Update button text
                        submitText.textContent = 'Link Sent!';
                        loadingSpinner.classList.add('hidden');
                        
                        // Add email to recent resets
                        const recentResets = JSON.parse(localStorage.getItem('recentPasswordResets') || '[]');
                        recentResets.push({
                            email: email,
                            timestamp: new Date().toISOString(),
                            ip: 'demo' // In real app, get from server
                        });
                        localStorage.setItem('recentPasswordResets', JSON.stringify(recentResets));
                        
                    } else {
                        // Reset button state
                        submitText.textContent = 'Send Reset Link';
                        loadingSpinner.classList.add('hidden');
                        submitButton.disabled = false;
                    }
                    
                }, 1500);
            });
            
            // Real-time validation
            emailInput.addEventListener('input', function() {
                emailError.classList.add('hidden');
                hideError();
                hideEmailCheckResult();
            });
            
            // Auto-detect common email domains and show helper text
            emailInput.addEventListener('blur', function() {
                const email = emailInput.value.trim();
                
                if (email && validateEmail(email)) {
                    const domain = email.split('@')[1]?.toLowerCase();
                    
                    if (commonEmailDomains.includes(domain)) {
                        // Show subtle indicator
                        console.log(`Detected ${domain} email`);
                    }
                }
            });
            
            // Setup demo
            function setupDemo() {
                // Initialize storage if not exists
                if (!localStorage.getItem('resetTokens')) {
                    localStorage.setItem('resetTokens', JSON.stringify({}));
                }
                if (!localStorage.getItem('manualResetRequests')) {
                    localStorage.setItem('manualResetRequests', JSON.stringify([]));
                }
                if (!localStorage.getItem('recentPasswordResets')) {
                    localStorage.setItem('recentPasswordResets', JSON.stringify([]));
                }
                
                // Demo instructions
                console.log('Password Reset System - Ready for Gmail/Yahoo/Hotmail users');
                console.log('Test with these demo accounts:');
                console.log('1. admin@mothersunion.org (Admin - Works)');
                console.log('2. mary@gmail.com (Regular Gmail - Check if registered)');
                console.log('3. john@yahoo.com (Regular Yahoo - Check if registered)');
            }
            
            // Initialize
            setupDemo();
        });
    </script>
</body>
</html>