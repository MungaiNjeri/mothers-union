<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Financial Overview &amp; Reports - Mothers' Union</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;family=Noto+Sans:wght@100..900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#17cf26",
                        "church-gold": "#D4AF37",
                        "background-light": "#f6f8f6",
                        "background-dark": "#112112",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"],
                        "sans": ["Noto Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        body {
            font-family: 'Lexend', sans-serif;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            background-color: #10b981;
        }
        .toast.info {
            background-color: #3b82f6;
        }
        .toast.warning {
            background-color: #f59e0b;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #17cf26;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Chart animations */
        .bar-animate {
            animation: growBar 1s ease-out forwards;
            transform-origin: bottom;
        }
        @keyframes growBar {
            from { transform: scaleY(0); }
            to { transform: scaleY(1); }
        }
        
        /* Pulse animation for updates */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .pulse {
            animation: pulse 1s ease-in-out;
        }
        
        /* Export modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .dark .modal-content {
            background: #112112;
            color: white;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111812] dark:text-white min-h-screen">
    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>
    
    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Export Report</h3>
                <button id="closeExportModal" class="text-gray-500 hover:text-gray-700">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Report Type</label>
                    <select id="exportType" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-700">
                        <option value="pdf">PDF Document</option>
                        <option value="csv">CSV Data</option>
                        <option value="excel">Excel Spreadsheet</option>
                        <option value="print">Print View</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Date Range</label>
                    <select id="exportRange" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-700">
                        <option value="current-year">Current Year (2026)</option>
                        <option value="last-year">Last Year (2025)</option>
                        <option value="last-6">Last 6 Months</option>
                        <option value="last-3">Last 3 Months</option>
                        <option value="current-month">Current Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div id="customDates" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">From</label>
                        <input type="date" id="exportFrom" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-700">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">To</label>
                        <input type="date" id="exportTo" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-700">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button id="cancelExport" class="px-4 py-2 border rounded hover:bg-gray-50 dark:hover:bg-gray-800">Cancel</button>
                    <button id="confirmExport" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">
                        <span id="exportButtonText">Export Report</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Top Navigation Bar -->
<div class="w-full flex flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark px-6 md:px-40 py-3">
<div class="flex items-center gap-4 text-[#111812] dark:text-white">
<div class="size-8 bg-primary rounded-lg flex items-center justify-center text-white">
<span class="material-symbols-outlined">church</span>
</div>
<h2 class="text-lg font-bold leading-tight tracking-[-0.015em] font-display">Mothers' Union Finance</h2>
</div>
<div class="flex flex-1 justify-end gap-8 items-center">
<nav class="hidden md:flex items-center gap-9">
<a class="text-sm font-medium leading-normal hover:text-primary transition-colors" href="dashboard.html">Dashboard</a>
<a class="text-sm font-medium leading-normal hover:text-primary transition-colors" href="transactions-new.html">Records</a>
<a class="text-sm font-medium leading-normal hover:text-primary transition-colors" href="Transactions.html">Transactions</a>
<a class="text-sm font-medium leading-normal hover:text-primary transition-colors" href="members.html">Members</a>
<a class="text-sm font-bold leading-normal text-primary" href="reports.html">Reports</a>
<a class="text-sm font-medium leading-normal hover:text-primary transition-colors" href="setting.html">Settings</a>
</nav>
<div class="flex items-center gap-4">
<button id="downloadPdf" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
<span class="truncate">Download PDF</span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border border-gray-200" data-alt="User profile avatar placeholder" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAi5cdZMsQePL6HMVex6MW7y3D2t28IsMm6jOxXVTbNdbj-aqOaIAli-4892hQZ_YHCjn883r9BpkDRPw4wz0-KBrfczZhiGuO-fZjknx0P3bVKpP6hcSX9sLyDxg1jsNXKCVEbL0OqDl0D7G_zMVRlpQgz1GvJg1lJ6YqCrNN2oOVg5CHr64b5wH91qmkKeCgjPsr0VfSyEZoBvAi1ZJ2lqag-gD3XPnniesV9R5mNHj05kTy5QwhH2jx1LQ52f50-nROVIan0jQ");'></div>
</div>
</div>
</header>
<main class="max-w-[1200px] mx-auto w-full px-6 py-8">
<!-- Page Heading -->
<div class="flex flex-wrap justify-between items-end gap-4 mb-8">
<div class="flex flex-col gap-2">
<h1 class="text-[#111812] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] font-display">Financial Overview</h1>
<p class="text-gray-600 dark:text-gray-400 text-lg font-normal">A simple visual summary of our union's funds for <span id="currentYearDisplay">2026</span>.</p>
</div>
<div class="flex gap-2">
<select id="timeRange" class="flex items-center gap-2 rounded-lg h-10 px-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-sm font-bold cursor-pointer">
<option value="current-year">This Year</option>
<option value="last-year">Last Year</option>
<option value="last-6">Last 6 Months</option>
<option value="last-3">Last 3 Months</option>
<option value="current-month">Current Month</option>
</select>
<button id="printView" class="flex items-center gap-2 rounded-lg h-10 px-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-sm font-bold hover:bg-gray-50 dark:hover:bg-gray-700">
<span class="material-symbols-outlined text-sm">print</span>
<span>Print View</span>
</button>
</div>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="hidden fixed top-0 left-0 w-full h-full bg-white/80 dark:bg-black/80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center gap-4">
        <div class="spinner"></div>
        <p class="text-gray-600 dark:text-gray-300">Generating financial insights...</p>
    </div>
</div>

<!-- Stats Summary Strip -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 shadow-sm">
<div class="flex items-center justify-between">
<p class="text-gray-600 dark:text-gray-400 text-sm font-medium uppercase tracking-wider">Money Coming In</p>
<span class="material-symbols-outlined text-primary">trending_up</span>
</div>
<p class="text-[#111812] dark:text-white tracking-tight text-3xl font-bold leading-tight" id="totalIncome">KSH 0</p>
<p class="text-primary text-sm font-bold" id="incomeChange">Loading...</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 shadow-sm">
<div class="flex items-center justify-between">
<p class="text-gray-600 dark:text-gray-400 text-sm font-medium uppercase tracking-wider">Money Spent</p>
<span class="material-symbols-outlined text-red-500">trending_down</span>
</div>
<p class="text-[#111812] dark:text-white tracking-tight text-3xl font-bold leading-tight" id="totalExpenses">KSH 0</p>
<p class="text-red-500 text-sm font-bold" id="expenseChange">Loading...</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 shadow-sm">
<div class="flex items-center justify-between">
<p class="text-gray-600 dark:text-gray-400 text-sm font-medium uppercase tracking-wider">Current Balance</p>
<span class="material-symbols-outlined text-church-gold">account_balance_wallet</span>
</div>
<p class="text-[#111812] dark:text-white tracking-tight text-3xl font-bold leading-tight" id="currentBalance">KSH 0</p>
<p class="text-primary text-sm font-bold" id="balanceStatus">Loading...</p>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Main Bar Chart: Income vs Expenses -->
<div class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-sm col-span-1 lg:col-span-2">
<div class="flex justify-between items-start">
<div>
<h2 class="text-xl font-bold text-[#111812] dark:text-white">Money Coming In vs. Money Spent</h2>
<p class="text-gray-600 dark:text-gray-400 text-sm mt-1">Comparing monthly cash flow for <span id="chartTimeRange">the current year</span></p>
</div>
<div class="flex gap-4 text-sm font-medium">
<div class="flex items-center gap-2"><span class="w-3 h-3 bg-primary rounded-full"></span> <span id="incomeLabel">Money In</span></div>
<div class="flex items-center gap-2"><span class="w-3 h-3 bg-church-gold rounded-full"></span> <span id="expenseLabel">Money Spent</span></div>
</div>
</div>
<div id="barChart" class="grid h-[300px] grid-flow-col gap-8 grid-rows-[1fr_auto] items-end justify-items-center px-4 mt-8">
<!-- Bars will be generated by JavaScript -->
</div>
<div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
<p class="text-sm text-gray-700 dark:text-gray-300" id="barChartSummary">
<strong>Summary:</strong> Loading financial data...
                        </p>
</div>
</div>
<!-- Pie Chart: Distribution by Category -->
<div class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-sm">
<h2 class="text-xl font-bold text-[#111812] dark:text-white">Where Our Money Goes</h2>
<p class="text-gray-600 dark:text-gray-400 text-sm">Distribution of expenses across different union activities</p>
<div class="flex items-center justify-center py-8">
<div id="pieChart" class="relative size-48 rounded-full shadow-inner flex items-center justify-center text-center p-6 border-8 border-white dark:border-gray-800">
<div class="absolute bg-white dark:bg-gray-900 rounded-full size-24 flex items-center justify-center shadow-lg">
<span class="text-xl font-bold" id="pieChartTotal">KSH 0</span>
</div>
</div>
</div>
<div id="pieChartLegend" class="grid grid-cols-2 gap-3 mt-4">
<!-- Legend will be generated by JavaScript -->
</div>
<div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
<p class="text-sm text-gray-700 dark:text-gray-300" id="pieChartSummary">
<strong>Summary:</strong> Loading expense distribution...
                        </p>
</div>
</div>
<!-- Line Chart: Contribution Trends -->
<div class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 shadow-sm">
<h2 class="text-xl font-bold text-[#111812] dark:text-white">Giving Trends</h2>
<p class="text-gray-600 dark:text-gray-400 text-sm">How regular member contributions change over time</p>
<div class="relative h-48 mt-8 flex items-end">
<svg id="lineChart" class="w-full h-full overflow-visible" preserveaspectratio="none" viewbox="0 0 400 100">
<!-- Line will be generated by JavaScript -->
</svg>
</div>
<div id="lineChartLabels" class="flex justify-between text-xs font-bold text-gray-500 mt-2 px-1">
<!-- Labels will be generated by JavaScript -->
</div>
<div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
<p class="text-sm text-gray-700 dark:text-gray-300" id="lineChartSummary">
<strong>Summary:</strong> Loading giving trends...
                        </p>
</div>
</div>
</div>
<!-- Detail Cards Grid -->
<div class="mt-12 mb-8">
<h3 class="text-2xl font-bold mb-6 font-display">Fund Breakdown Details</h3>
<div id="fundCards" class="grid grid-cols-1 md:grid-cols-3 gap-6">
<!-- Cards will be generated by JavaScript -->
</div>
</div>
<footer class="mt-16 pb-12 text-center text-gray-500 text-sm">
<div class="border-t border-gray-200 dark:border-gray-800 pt-8">
<p>Â© <span id="footerYear">2026</span> Mothers' Union Anglican Church - Finance Dashboard</p>
<p class="mt-1 italic">"Bear one another's burdens, and so fulfill the law of Christ." (Galatians 6:2)</p>
<p class="mt-2 text-xs text-gray-400">Last updated: <span id="lastUpdated">Just now</span></p>
</div>
</footer>
</main>
</div>

<script>
// Toast notification function
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">
                ${type === 'success' ? 'check_circle' : 
                  type === 'warning' ? 'warning' : 'info'}
            </span>
            <span>${message}</span>
        </div>
    `;
    toastContainer.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Format currency
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-KE', {
        style: 'currency',
        currency: 'KES',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount).replace('KES', 'KSH');
}

// Format percentage
function formatPercentage(value) {
    return `${value > 0 ? '+' : ''}${value.toFixed(1)}%`;
}

// Get date range based on selection
function getDateRange(rangeType) {
    const now = new Date();
    const start = new Date();
    
    switch(rangeType) {
        case 'current-month':
            start.setDate(1);
            break;
        case 'last-3':
            start.setMonth(now.getMonth() - 3);
            break;
        case 'last-6':
            start.setMonth(now.getMonth() - 6);
            break;
        case 'last-year':
            start.setFullYear(now.getFullYear() - 1);
            start.setMonth(0);
            start.setDate(1);
            break;
        case 'current-year':
        default:
            start.setMonth(0);
            start.setDate(1);
            break;
    }
    
    return { start, end: now };
}

// Get month name
function getMonthName(monthIndex) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return months[monthIndex];
}

// Calculate financial statistics
function calculateFinancialStats(transactions, dateRange) {
    const { start, end } = dateRange;
    
    let totalIncome = 0;
    let totalExpenses = 0;
    let incomeByMonth = Array(12).fill(0);
    let expensesByMonth = Array(12).fill(0);
    let categoryBreakdown = {};
    let monthlyContributions = Array(12).fill(0);
    
    // Filter transactions by date range
    const filteredTransactions = transactions.filter(tx => {
        const txDate = new Date(tx.date);
        return txDate >= start && txDate <= end;
    });
    
    // Calculate statistics
    filteredTransactions.forEach(tx => {
        const txDate = new Date(tx.date);
        const month = txDate.getMonth();
        const amount = parseFloat(tx.amount);
        
        if (tx.type === 'money_in') {
            totalIncome += amount;
            incomeByMonth[month] += amount;
            
            // Track contributions (tithe and offering)
            if (tx.category === 'Tithe' || tx.category === 'Offering') {
                monthlyContributions[month] += amount;
            }
        } else {
            totalExpenses += amount;
            expensesByMonth[month] += amount;
            
            // Categorize expenses
            if (!categoryBreakdown[tx.category]) {
                categoryBreakdown[tx.category] = 0;
            }
            categoryBreakdown[tx.category] += amount;
        }
    });
    
    // Calculate percentage changes (simulated for demo)
    const incomeChange = Math.random() * 20 - 5; // -5% to +15%
    const expenseChange = Math.random() * 15 - 10; // -10% to +5%
    
    // Calculate current balance (starting from a base)
    const startingBalance = 10000;
    const currentBalance = startingBalance + totalIncome - totalExpenses;
    
    // Find largest expense category
    let largestCategory = { name: 'None', amount: 0 };
    for (const [category, amount] of Object.entries(categoryBreakdown)) {
        if (amount > largestCategory.amount) {
            largestCategory = { name: category, amount };
        }
    }
    
    // Find month with highest contributions
    let highestContributionMonth = 0;
    let highestContribution = 0;
    monthlyContributions.forEach((amount, month) => {
        if (amount > highestContribution) {
            highestContribution = amount;
            highestContributionMonth = month;
        }
    });
    
    return {
        totalIncome,
        totalExpenses,
        currentBalance,
        incomeChange,
        expenseChange,
        incomeByMonth,
        expensesByMonth,
        categoryBreakdown,
        monthlyContributions,
        largestCategory,
        highestContributionMonth,
        highestContribution
    };
}

// Generate bar chart
function generateBarChart(incomeByMonth, expensesByMonth, dateRange) {
    const container = document.getElementById('barChart');
    const { start, end } = dateRange;
    
    // Determine which months to show
    const startMonth = start.getMonth();
    const endMonth = end.getMonth();
    const monthsToShow = [];
    
    for (let i = startMonth; i <= endMonth; i++) {
        monthsToShow.push(i % 12);
    }
    
    // Find max value for scaling
    const allValues = [...incomeByMonth, ...expensesByMonth];
    const maxValue = Math.max(...allValues, 1000); // Minimum of 1000 for scaling
    
    let barsHTML = '';
    let labelsHTML = '';
    
    monthsToShow.forEach(monthIndex => {
        const incomeHeight = (incomeByMonth[monthIndex] / maxValue) * 100;
        const expenseHeight = (expensesByMonth[monthIndex] / maxValue) * 100;
        
        barsHTML += `
            <div class="flex items-end gap-1 h-full w-full">
                <div class="bar-animate bg-primary/80 w-full rounded-t" style="height: ${incomeHeight}%;" title="Income: ${formatCurrency(incomeByMonth[monthIndex])}"></div>
                <div class="bar-animate bg-church-gold/80 w-full rounded-t" style="height: ${expenseHeight}%;" title="Expenses: ${formatCurrency(expensesByMonth[monthIndex])}"></div>
            </div>
        `;
        
        labelsHTML += `<p class="text-xs font-bold text-gray-500 mt-2">${getMonthName(monthIndex)}</p>`;
    });
    
    container.innerHTML = barsHTML + labelsHTML;
}

// Generate pie chart
function generatePieChart(categoryBreakdown, totalExpenses) {
    const pieChart = document.getElementById('pieChart');
    const legend = document.getElementById('pieChartLegend');
    
    if (totalExpenses === 0) {
        pieChart.innerHTML = `
            <div class="absolute bg-white dark:bg-gray-900 rounded-full size-24 flex items-center justify-center shadow-lg">
                <span class="text-sm text-gray-500">No expenses</span>
            </div>
        `;
        legend.innerHTML = '<p class="text-gray-500 text-sm col-span-2 text-center">No expense data available</p>';
        return;
    }
    
    // Color palette for categories
    const colors = {
        'Tithe': '#17cf26',
        'Offering': '#D4AF37',
        'Project Fund': '#638866',
        'Membership Fee': '#3b82f6',
        'Donation': '#8b5cf6',
        'Utilities': '#ef4444',
        'Community Event': '#f59e0b',
        'Welfare': '#10b981',
        'default': '#f0f4f1'
    };
    
    // Sort categories by amount
    const sortedCategories = Object.entries(categoryBreakdown)
        .sort(([, a], [, b]) => b - a);
    
    // Calculate percentages and build conic-gradient
    let gradientString = '';
    let accumulatedPercent = 0;
    
    sortedCategories.forEach(([category, amount], index) => {
        const percentage = (amount / totalExpenses) * 100;
        const color = colors[category] || colors.default;
        
        gradientString += `${color} ${accumulatedPercent}% ${accumulatedPercent + percentage}%`;
        if (index < sortedCategories.length - 1) {
            gradientString += ', ';
        }
        
        accumulatedPercent += percentage;
    });
    
    // Update pie chart
    pieChart.style.background = `conic-gradient(${gradientString})`;
    document.getElementById('pieChartTotal').textContent = formatCurrency(totalExpenses);
    
    // Update legend
    let legendHTML = '';
    sortedCategories.forEach(([category, amount]) => {
        const percentage = ((amount / totalExpenses) * 100).toFixed(1);
        const color = colors[category] || colors.default;
        
        legendHTML += `
            <div class="flex items-center gap-2 text-sm">
                <div class="w-3 h-3 rounded-sm" style="background-color: ${color};"></div>
                <span class="font-medium">${category} (${percentage}%)</span>
            </div>
        `;
    });
    
    legend.innerHTML = legendHTML;
}

// Generate line chart
function generateLineChart(monthlyContributions, dateRange) {
    const lineChart = document.getElementById('lineChart');
    const labels = document.getElementById('lineChartLabels');
    const { start, end } = dateRange;
    
    // Determine which months to show
    const startMonth = start.getMonth();
    const endMonth = end.getMonth();
    const monthsToShow = [];
    
    for (let i = startMonth; i <= endMonth; i++) {
        monthsToShow.push(i % 12);
    }
    
    // Find max value for scaling
    const maxValue = Math.max(...monthlyContributions, 1000);
    
    // Generate path data points
    const points = monthsToShow.map((monthIndex, i) => {
        const x = (i / (monthsToShow.length - 1)) * 400;
        const y = 100 - (monthlyContributions[monthIndex] / maxValue) * 80;
        return { x, y };
    });
    
    // Build SVG path
    let pathData = `M${points[0].x},${points[0].y}`;
    for (let i = 1; i < points.length; i++) {
        const prev = points[i - 1];
        const curr = points[i];
        const cpX1 = prev.x + (curr.x - prev.x) / 3;
        const cpX2 = curr.x - (curr.x - prev.x) / 3;
        pathData += ` C${cpX1},${prev.y} ${cpX2},${curr.y} ${curr.x},${curr.y}`;
    }
    
    // Build area path (same as line but closed at bottom)
    let areaData = pathData;
    areaData += ` V100 H0 V${points[0].y} Z`;
    
    // Build SVG
    lineChart.innerHTML = `
        <path d="${areaData}" fill="url(#grad1)" opacity="0.1"></path>
        <path d="${pathData}" fill="none" stroke="#17cf26" stroke-linecap="round" stroke-width="4"></path>
        <defs>
            <linearGradient id="grad1" x1="0%" x2="0%" y1="0%" y2="100%">
                <stop offset="0%" style="stop-color:#17cf26;stop-opacity:1"></stop>
                <stop offset="100%" style="stop-color:#17cf26;stop-opacity:0"></stop>
            </linearGradient>
        </defs>
        ${points.map((point, i) => `
            <circle cx="${point.x}" cy="${point.y}" fill="#17cf26" r="4">
                <title>${getMonthName(monthsToShow[i])}: ${formatCurrency(monthlyContributions[monthsToShow[i]])}</title>
            </circle>
        `).join('')}
    `;
    
    // Update labels
    labels.innerHTML = monthsToShow.map(monthIndex => 
        `<span>${getMonthName(monthIndex)}</span>`
    ).join('');
}

// Update fund cards
function updateFundCards(categoryBreakdown) {
    const container = document.getElementById('fundCards');
    
    // Map categories to card data
    const cardData = [
        {
            id: 'welfare',
            title: 'Welfare Fund',
            description: 'Supporting members in need',
            icon: 'favorite',
            color: 'primary',
            amount: categoryBreakdown['Welfare'] || categoryBreakdown['Membership Fee'] || 0
        },
        {
            id: 'events',
            title: 'Events & Meetings',
            description: 'Monthly teas and yearly retreat',
            icon: 'event',
            color: 'church-gold',
            amount: categoryBreakdown['Community Event'] || 0
        },
        {
            id: 'tithes',
            title: 'Tithes & Dues',
            description: 'Regular monthly contributions',
            icon: 'volunteer_activism',
            color: 'green-800',
            amount: (categoryBreakdown['Tithe'] || 0) + (categoryBreakdown['Offering'] || 0)
        }
    ];
    
    let cardsHTML = '';
    
    cardData.forEach(card => {
        cardsHTML += `
            <div class="flex flex-col gap-3 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-5 shadow-sm">
                <div class="size-10 rounded-full bg-${card.color}/10 flex items-center justify-center text-${card.color}">
                    <span class="material-symbols-outlined">${card.icon}</span>
                </div>
                <div class="flex flex-col gap-1">
                    <h4 class="text-lg font-bold text-[#111812] dark:text-white">${card.title}</h4>
                    <p class="text-gray-600 dark:text-gray-400 text-sm leading-normal">
                        ${formatCurrency(card.amount)} ${card.description}
                    </p>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = cardsHTML;
}

// Update all charts and statistics
function updateAllCharts() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    loadingIndicator.classList.remove('hidden');
    
    // Get current time range
    const timeRange = document.getElementById('timeRange').value;
    const dateRange = getDateRange(timeRange);
    
    // Get transactions from localStorage
    const transactions = JSON.parse(localStorage.getItem('mothersUnionTransactions') || '[]');
    
    // Calculate statistics
    const stats = calculateFinancialStats(transactions, dateRange);
    
    // Update summary cards with animation
    document.getElementById('totalIncome').textContent = formatCurrency(stats.totalIncome);
    document.getElementById('totalExpenses').textContent = formatCurrency(stats.totalExpenses);
    document.getElementById('currentBalance').textContent = formatCurrency(stats.currentBalance);
    
    document.getElementById('incomeChange').textContent = `${formatPercentage(stats.incomeChange)} from last period`;
    document.getElementById('expenseChange').textContent = `${formatPercentage(stats.expenseChange)} vs target budget`;
    document.getElementById('balanceStatus').textContent = stats.currentBalance > 0 ? 'Healthy surplus' : 'Attention needed';
    
    // Update chart labels
    document.getElementById('chartTimeRange').textContent = {
        'current-year': 'the current year',
        'last-year': 'last year',
        'last-6': 'the last 6 months',
        'last-3': 'the last 3 months',
        'current-month': 'the current month'
    }[timeRange] || 'the current year';
    
    // Update charts
    generateBarChart(stats.incomeByMonth, stats.expensesByMonth, dateRange);
    generatePieChart(stats.categoryBreakdown, stats.totalExpenses);
    generateLineChart(stats.monthlyContributions, dateRange);
    
    // Update summary text
    document.getElementById('barChartSummary').innerHTML = `
        <strong>Summary:</strong> So far, we have saved <strong>${formatCurrency(stats.totalIncome - stats.totalExpenses)}</strong> more than we spent.
    `;
    
    document.getElementById('pieChartSummary').innerHTML = `
        <strong>Summary:</strong> The largest spend this period was <strong>${formatCurrency(stats.largestCategory.amount)}</strong> on ${stats.largestCategory.name.toLowerCase()}.
    `;
    
    document.getElementById('lineChartSummary').innerHTML = `
        <strong>Summary:</strong> Giving is at its highest in <strong>${getMonthName(stats.highestContributionMonth)}</strong> with ${formatCurrency(stats.highestContribution)} in contributions.
    `;
    
    // Update fund cards
    updateFundCards(stats.categoryBreakdown);
    
    // Update last updated time
    const now = new Date();
    document.getElementById('lastUpdated').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Add pulse animation to updated elements
    const updatedElements = [
        'totalIncome', 'totalExpenses', 'currentBalance',
        'barChartSummary', 'pieChartSummary', 'lineChartSummary'
    ];
    
    updatedElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.add('pulse');
            setTimeout(() => element.classList.remove('pulse'), 1000);
        }
    });
    
    // Hide loading indicator
    setTimeout(() => {
        loadingIndicator.classList.add('hidden');
        showToast('Financial report updated successfully', 'success');
    }, 500);
}

// Export report
function exportReport() {
    const exportType = document.getElementById('exportType').value;
    const exportRange = document.getElementById('exportRange').value;
    const buttonText = document.getElementById('exportButtonText');
    
    buttonText.innerHTML = '<div class="spinner"></div>';
    
    // Simulate export process
    setTimeout(() => {
        buttonText.textContent = 'Export Report';
        document.getElementById('exportModal').classList.remove('show');
        
        if (exportType === 'print') {
            window.print();
            showToast('Opening print preview...', 'info');
        } else {
            showToast(`${exportType.toUpperCase()} report exported successfully!`, 'success');
            
            // In a real app, you would generate and download the file here
            // For demo purposes, we'll create a dummy download
            const dummyData = "Financial Report Data\nGenerated on: " + new Date().toLocaleDateString();
            const blob = new Blob([dummyData], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mothers-union-report-${new Date().toISOString().split('T')[0]}.${exportType}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    }, 1500);
}

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    // Set current year
    const currentYear = new Date().getFullYear();
    document.getElementById('currentYearDisplay').textContent = currentYear;
    document.getElementById('footerYear').textContent = currentYear;
    
    // Check if we have transaction data
    const transactions = JSON.parse(localStorage.getItem('mothersUnionTransactions') || '[]');
    if (transactions.length === 0) {
        showToast('No transaction data found. Add some transactions to see reports.', 'warning');
    }
    
    // Initial chart render
    updateAllCharts();
    
    // Event Listeners
    
    // Time range selector
    document.getElementById('timeRange').addEventListener('change', updateAllCharts);
    
    // Print view button
    document.getElementById('printView').addEventListener('click', function() {
        window.print();
        showToast('Opening print preview...', 'info');
    });
    
    // Download PDF button
    document.getElementById('downloadPdf').addEventListener('click', function() {
        document.getElementById('exportModal').classList.add('show');
        document.getElementById('exportType').value = 'pdf';
    });
    
    // Export modal
    document.getElementById('closeExportModal').addEventListener('click', function() {
        document.getElementById('exportModal').classList.remove('show');
    });
    
    document.getElementById('cancelExport').addEventListener('click', function() {
        document.getElementById('exportModal').classList.remove('show');
    });
    
    document.getElementById('exportRange').addEventListener('change', function() {
        const customDates = document.getElementById('customDates');
        if (this.value === 'custom') {
            customDates.classList.remove('hidden');
        } else {
            customDates.classList.add('hidden');
        }
    });
    
    document.getElementById('confirmExport').addEventListener('click', exportReport);
    
    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
        const modal = document.getElementById('exportModal');
        if (e.target === modal) {
            modal.classList.remove('show');
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            updateAllCharts();
            showToast('Refreshing report data...', 'info');
        }
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            window.print();
        }
        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            document.getElementById('exportModal').classList.add('show');
        }
    });
    
    // Auto-refresh every 5 minutes
    setInterval(updateAllCharts, 300000);
    
    // Simulate real-time updates every 30 seconds (for demo)
    setInterval(() => {
        // In a real app, this would check for new data
        // For demo, we'll just update with current data
        updateAllCharts();
    }, 30000);
    
    // Show keyboard shortcuts help on first visit
    if (!localStorage.getItem('reportsHelpShown')) {
        setTimeout(() => {
            showToast('Tip: Use Ctrl+R to refresh, Ctrl+P to print, Ctrl+E to export', 'info');
            localStorage.setItem('reportsHelpShown', 'true');
        }, 2000);
    }
    
    // Add hover effects to charts
    document.addEventListener('mouseover', function(e) {
        if (e.target.classList.contains('bar-animate')) {
            e.target.style.opacity = '0.9';
        }
    });
    
    document.addEventListener('mouseout', function(e) {
        if (e.target.classList.contains('bar-animate')) {
            e.target.style.opacity = '';
        }
    });
});
</script>
</body>
</html>